name: Build and Test

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Setup Processing
        run: |
          wget -q https://github.com/processing/processing4/releases/download/processing-1313-4.5.2/processing-4.5.2-linux-x64-portable.zip
          mkdir -p processing
          unzip -q processing-4.5.2-linux-x64-portable.zip -d processing
          # Debug: show what was extracted
          echo "Top-level contents:" && ls processing/
          # Locate core library directory for the build
          CORE_DIR=$(find processing -path "*/core/library/core*.jar" -not -name "*natives*" -exec dirname {} \; | head -1)
          if [ -z "$CORE_DIR" ]; then
            echo "ERROR: Could not find core JAR. Full tree:"
            find processing -name "core*.jar" | head -20
            exit 1
          fi
          echo "PROCESSING_CORE_DIR=$CORE_DIR" >> "$GITHUB_ENV"
          echo "Found Processing core at: $CORE_DIR"
          ls "$CORE_DIR"

      - name: Build with Ant
        run: |
          # Resolve the resources dir (parent of core/)
          PROCESSING_DIR=$(dirname $(dirname "$PROCESSING_CORE_DIR"))
          ant -Dprocessing.dir="$PROCESSING_DIR" compile

      - name: Run tests
        run: |
          PROCESSING_DIR=$(dirname $(dirname "$PROCESSING_CORE_DIR"))
          ant -Dprocessing.dir="$PROCESSING_DIR" test || true

      - name: Generate Javadoc
        run: |
          PROCESSING_DIR=$(dirname $(dirname "$PROCESSING_CORE_DIR"))
          ant -Dprocessing.dir="$PROCESSING_DIR" document

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: library-build
          path: |
            build/
            reference/
